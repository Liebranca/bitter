# KVR GNU MAKEFILE

#   ---     ---     ---     ---     ---
# platform switch

ifdef x32
PLAT = x32
PFLG = -m32
else
PLAT = x64
PFLG = -m64
endif

#   ---     ---     ---     ---     ---

AVTO_FILES = $(CURDIR)/AVTOMAT/calout.h

#   ---     ---     ---     ---     ---

.PHONY: kvrnel grim mamm sin chasm spwn shb7 nrun reb clean all

$(CURDIR)/AVTO:
	@cd $(CURDIR)/AVTOMAT; python avtomat.py; \
    echo "ES-AVTOMAT: files generated by $(shell hostname) on $(shell date)" \
         > $(CURDIR)/AVTO

grim: $(CURDIR)/AVTO
	@cd $(CURDIR)/GRIM; make

kvrnel: $(CURDIR)/AVTO
	@cd $(CURDIR)/KVRNEL; make

mamm: kvrnel
	@cd $(CURDIR)/MAMMOTH; make

sin: kvrnel
	@cd $(CURDIR)/SIN; make

chasm: sin
	@cd $(CURDIR)/CHASM; make

spwn:
	gcc -s -Os -fno-unwind-tables -fno-asynchronous-unwind-tables -fsingle-precision-constant -ffast-math -fno-ident -flto -ffunction-sections -fdata-sections -Wl,--gc-sections -Wl,-fuse-ld=bfd -I./ ./spwn.c -L./../bin/$(PLAT)/ -lkvrnel -o ./../bin/$(PLAT)/spwn; mv ./../bin/$(PLAT)/spwn.exe ./../bin/$(PLAT)/spwn

shb7: chasm spwn
	@cd $(CURDIR)/SHB7; make

nrun: shb7
	@clear; ../bin/$(PLAT)/shb7

rrun:
	@../bin/$(PLAT)/shb7

clean:
	@echo Cleaning up...
	@echo kvrnel
	@cd $(CURDIR)/KVRNEL; make clean -s;
	@echo grim
	@cd $(CURDIR)/GRIM; make clean -s;
	@echo mammoth
	@cd $(CURDIR)/MAMMOTH; make clean -s;
	@echo sin
	@cd $(CURDIR)/SIN; make clean -s;
	@echo chasm
	@cd $(CURDIR)/CHASM; make clean -s;
	@echo shb7
	@cd $(CURDIR)/SHB7; make clean -s;
	@rm -f $(CURDIR)/AVTO

all: | kvrnel mamm sin chasm spwn shb7 mamm
reb: | clean kvrnel mamm sin chasm spwn shb7

#   ---     ---     ---     ---     ---